AWSTemplateFormatVersion: 2010-09-09
Description: 'API Gateway with OpenAPI specification, Cognito authentication, and Lambda authorizer'

Parameters:
  Environment:
    Type: String
    Default: dev
    Description: Environment name
  
  ProjectName:
    Type: String
    Default: openapi-cognito-auth
    Description: Project name for resource naming

  EnableVerifiedPermissions:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
    Description: Enable AWS Verified Permissions resources (PolicyStore/IdentitySource)

  PrincipalEntityType:
    Type: String
    Default: User
    Description: Cedar principal entity type name used for Cognito identities (matches schema)

Conditions:
  UseAvp: !Equals [ !Ref EnableVerifiedPermissions, "true" ]

Resources:
  # ===== IAM Roles =====
  
  # IAM Role for PreTokenGeneration Lambda
  PreTokenGenerationLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-pretoken-role-${Environment}"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: CognitoAccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
              - Effect: Allow
                Action:
                  - cognito-idp:AdminListGroupsForUser
                  - cognito-idp:AdminUpdateUserAttributes
                  - cognito-idp:AdminGetUser
                Resource: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/*"

  # IAM Role for Lambda Authorizer
  LambdaAuthorizerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-authorizer-role-${Environment}"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: VerifiedPermissionsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - verifiedpermissions:IsAuthorized
                  - verifiedpermissions:IsAuthorizedWithToken
                Resource: "*"

  # IAM Role for Backend Lambda
  BackendLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-backend-role-${Environment}"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  # IAM Role for Revoke Token Lambda
  RevokeTokenLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-revoke-token-role-${Environment}"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: CognitoRevokeTokenPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
              - Effect: Allow
                Action:
                  - cognito-idp:AdminUserGlobalSignOut
                  - cognito-idp:AdminGetUser
                Resource: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/*"

  # IAM Role for Login Lambda
  LoginLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-login-role-${Environment}"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: CognitoLoginPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
              - Effect: Allow
                Action:
                  - cognito-idp:AdminInitiateAuth
                Resource: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/*"

  # IAM Role for Refresh Token Lambda
  RefreshTokenLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-refresh-token-role-${Environment}"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: CognitoRefreshTokenPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
              - Effect: Allow
                Action:
                  - cognito-idp:AdminInitiateAuth
                Resource: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/*"

  # IAM Role for API Gateway to invoke Lambda
  ApiGatewayRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-apigateway-role-${Environment}"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: LambdaInvokePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: "*"

  # ===== Lambda Functions =====
  
  # PreTokenGeneration Lambda Function
  PreTokenGenerationLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-pretoken-${Environment}"
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt PreTokenGenerationLambdaRole.Arn
      Timeout: 30
      Code:
        ZipFile: |
          # Placeholder code - will be replaced during deployment
          def lambda_handler(event, context):
              return event
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  # Lambda Authorizer Function
  LambdaAuthorizerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-authorizer-${Environment}"
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt LambdaAuthorizerRole.Arn
      Timeout: 30
      Code:
        ZipFile: |
          # Placeholder code - will be replaced by scripts/lambda/authorizer.py during deployment
          def lambda_handler(event, context):
              return {
                  'principalId': 'unknown',
                  'policyDocument': {
                      'Version': '2012-10-17',
                      'Statement': [{
                          'Action': 'execute-api:Invoke',
                          'Effect': 'Allow',
                          'Resource': event['methodArn']
                      }]
                  }
              }
      Environment:
        Variables:
          POLICY_STORE_ID: !If [ UseAvp, !Ref AvpPolicyStore, "" ]
          PRINCIPAL_ENTITY_TYPE: !Ref PrincipalEntityType
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  # Backend Lambda Function
  BackendLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-backend-${Environment}"
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt BackendLambdaRole.Arn
      Timeout: 30
      Code:
        ZipFile: |
          # Placeholder code - will be replaced by scripts/lambda/backend.py during deployment
          def lambda_handler(event, context):
              return {
                  'statusCode': 200,
                  'headers': {'Content-Type': 'application/json'},
                  'body': '{"message": "Placeholder"}'
              }
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  # Revoke Token Lambda Function
  RevokeTokenLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-revoke-token-${Environment}"
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt RevokeTokenLambdaRole.Arn
      Timeout: 30
      Code:
        ZipFile: |
          # Placeholder code - will be replaced by scripts/lambda/revoke.py during deployment
          def lambda_handler(event, context):
              return {
                  'statusCode': 200,
                  'headers': {'Content-Type': 'application/json'},
                  'body': '{"message": "Placeholder"}'
              }
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName
  # Login Lambda Function
  LoginLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-login-${Environment}"
      Runtime: python3.12
      Handler: index.lambda_handler
      Role: !GetAtt LoginLambdaRole.Arn
      Timeout: 30
      Environment:
        Variables:
          USER_POOL_ID: !Ref CognitoUserPool
          CLIENT_ID: !Ref CognitoUserPoolClient
      Code:
        ZipFile: |
          # Placeholder code - will be replaced by scripts/lambda/login.py during deployment
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': 'Placeholder'}
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  # Refresh Token Lambda Function
  RefreshTokenLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-refresh-token-${Environment}"
      Runtime: python3.12
      Handler: index.lambda_handler
      Role: !GetAtt RefreshTokenLambdaRole.Arn
      Timeout: 30
      Environment:
        Variables:
          USER_POOL_ID: !Ref CognitoUserPool
          CLIENT_ID: !Ref CognitoUserPoolClient
      Code:
        ZipFile: |
          # Placeholder code - will be replaced by scripts/lambda/refresh.py during deployment
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': 'Placeholder'}
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName


  # ===== Lambda Permissions =====
  
  # Permission for Cognito to invoke PreTokenGeneration Lambda
  PreTokenGenerationLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref PreTokenGenerationLambda
      Action: lambda:InvokeFunction
      Principal: cognito-idp.amazonaws.com

  # Permission for API Gateway to invoke Lambda Authorizer
  LambdaAuthorizerPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref LambdaAuthorizerFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:*/*/*"

  # Permission for API Gateway to invoke Backend Lambda
  BackendLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref BackendLambdaFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:*/*/*"

  # Permission for API Gateway to invoke Revoke Token Lambda
  RevokeTokenLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref RevokeTokenLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:*/*/*"
  # Permission for API Gateway to invoke Login Lambda
  LoginLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref LoginLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:*/*/*"

  # Permission for API Gateway to invoke Refresh Token Lambda
  RefreshTokenLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref RefreshTokenLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:*/*/*"


  # ===== Cognito Resources =====
  
  # Cognito User Pool
  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub "${ProjectName}-user-pool-${Environment}"
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
      AutoVerifiedAttributes:
        - email
      Schema:
        - Name: email
          AttributeDataType: String
          Required: false
          Mutable: true
        - Name: role
          AttributeDataType: String
          Required: false
          Mutable: true
      LambdaConfig:
        PreTokenGeneration: !GetAtt PreTokenGenerationLambda.Arn
      UserPoolTags:
        Environment: !Ref Environment
        Project: !Ref ProjectName

  # Cognito User Pool Client - Fixed resource type
  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub "${ProjectName}-client-${Environment}"
      UserPoolId: !Ref CognitoUserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_ADMIN_USER_PASSWORD_AUTH
      SupportedIdentityProviders:
        - COGNITO
      CallbackURLs:
        - http://localhost:3000
      LogoutURLs:
        - http://localhost:3000
      AllowedOAuthFlows:
        - code
        - implicit
      AllowedOAuthScopes:
        - email
        - openid
        - profile
      AllowedOAuthFlowsUserPoolClient: true

  # Cognito User Pool Domain
  CognitoUserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: !Sub "openapi-auth-${Environment}-${AWS::AccountId}"
      UserPoolId: !Ref CognitoUserPool

  # Cognito User Groups
  CognitoAdminGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: api-admins
      UserPoolId: !Ref CognitoUserPool
      Description: Group for API administrators

  CognitoUserGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: api-users
      UserPoolId: !Ref CognitoUserPool
      Description: Group for API users

  # ===== API Gateway =====
  
  # API Gateway REST API (will be overwritten by OpenAPI import)
  ApiGatewayRestApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub "${ProjectName}-api-${Environment}"
      Description: API Gateway with OpenAPI specification and Cognito authentication
      EndpointConfiguration:
        Types:
          - REGIONAL
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  # ===== Amazon Verified Permissions (optional) =====
  AvpPolicyStore:
    Condition: UseAvp
    Type: AWS::VerifiedPermissions::PolicyStore
    Properties:
      Description: !Sub "Policy store for ${ProjectName} (${Environment})"
      ValidationSettings:
        Mode: STRICT
      # Note: Schema will be set after deployment via AWS CLI
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  AvpIdentitySource:
    Condition: UseAvp
    Type: AWS::VerifiedPermissions::IdentitySource
    Properties:
      PolicyStoreId: !Ref AvpPolicyStore
      PrincipalEntityType: !Ref PrincipalEntityType
      Configuration:
        CognitoUserPoolConfiguration:
          UserPoolArn: !GetAtt CognitoUserPool.Arn
          ClientIds:
            - !Ref CognitoUserPoolClient
      # Note: Policies will be created after deployment via AWS CLI

Outputs:
  CognitoUserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref CognitoUserPool
    Export:
      Name: !Sub "${AWS::StackName}-UserPoolId"

  CognitoUserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref CognitoUserPoolClient
    Export:
      Name: !Sub "${AWS::StackName}-UserPoolClientId"

  CognitoUserPoolArn:
    Description: Cognito User Pool ARN
    Value: !GetAtt CognitoUserPool.Arn
    Export:
      Name: !Sub "${AWS::StackName}-UserPoolArn"

  BackendLambdaArn:
    Description: Backend Lambda Function ARN
    Value: !GetAtt BackendLambdaFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-BackendLambdaArn"

  LambdaAuthorizerArn:
    Description: Lambda Authorizer Function ARN
    Value: !GetAtt LambdaAuthorizerFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-LambdaAuthorizerArn"

  ApiGatewayRoleArn:
    Description: API Gateway IAM Role ARN
    Value: !GetAtt ApiGatewayRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ApiGatewayRoleArn"

  ApiGatewayRestApiId:
    Description: API Gateway REST API ID
    Value: !Ref ApiGatewayRestApi
    Export:
      Name: !Sub "${AWS::StackName}-ApiGatewayRestApiId"

  RevokeTokenLambdaArn:
    Description: Revoke Token Lambda Function ARN
    Value: !GetAtt RevokeTokenLambda.Arn
    Export:
      Name: !Sub "${AWS::StackName}-RevokeTokenLambdaArn"

  ApiGatewayEndpoint:
    Description: API Gateway Endpoint URL
    Value: !Sub "https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}"
    Export:
      Name: !Sub "${AWS::StackName}-ApiGatewayEndpoint"

  LoginLambdaArn:
    Description: Login Lambda Function ARN
    Value: !GetAtt LoginLambda.Arn
    Export:
      Name: !Sub "${AWS::StackName}-LoginLambdaArn"

  RefreshTokenLambdaArn:
    Description: Refresh Token Lambda Function ARN
    Value: !GetAtt RefreshTokenLambda.Arn
    Export:
      Name: !Sub "${AWS::StackName}-RefreshTokenLambdaArn"

  AvpPolicyStoreId:
    Condition: UseAvp
    Description: Verified Permissions Policy Store ID
    Value: !Ref AvpPolicyStore
    Export:
      Name: !Sub "${AWS::StackName}-AvpPolicyStoreId"

  AvpIdentitySourceId:
    Condition: UseAvp
    Description: Verified Permissions Identity Source ID
    Value: !Ref AvpIdentitySource
    Export:
      Name: !Sub "${AWS::StackName}-AvpIdentitySourceId"