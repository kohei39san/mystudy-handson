version: '3.8'

services:
  test-runner:
    image: ubuntu:22.04
    container_name: api-test-runner
    working_dir: /workspace
    volumes:
      - ./tests:/workspace/tests
      - ./scripts/lambda:/workspace/lambda
    env_file:
      - .env
    command: >
      bash -c "
        apt-get update -qq && apt-get install -y -qq curl jq > /dev/null 2>&1 &&
        bash /workspace/tests/test-login-user.sh --api-endpoint \"$$API_ENDPOINT\" --username \"$$USERNAME\" --password \"$$PASSWORD\"
      "
    network_mode: bridge

  # Python test runner (for Python-based tests)
  python-test-runner:
    image: ubuntu:22.04
    container_name: api-python-test-runner
    working_dir: /workspace
    volumes:
      - ./tests:/workspace/tests
      - ./scripts:/workspace/scripts
      - ~/.aws:/root/.aws
    environment:
      - API_ENDPOINT=${API_ENDPOINT:-https://your-api-id.execute-api.region.amazonaws.com/stage}
      - USER_POOL_ID=${USER_POOL_ID:-}
      - CLIENT_ID=${CLIENT_ID:-}
      - AWS_REGION=${AWS_REGION:-ap-northeast-1}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-ap-northeast-1}
    command: >
      bash -c "
        echo '=== Installing Python and dependencies ===' &&
        apt-get update && apt-get install -y python3 python3-pip &&
        pip3 install boto3 requests &&
        echo '=== Running Python tests ===' &&
        python3 /workspace/tests/test-login.py --api-endpoint $$API_ENDPOINT
      "
    network_mode: bridge
