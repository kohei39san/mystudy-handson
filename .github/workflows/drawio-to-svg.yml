name: Convert Draw.io to SVG

permissions:
  contents: write
  pull-requests: write

on:
  push:
    paths:
      - "**/*.drawio"

jobs:
  convert-drawio-to-svg:
    name: Convert Draw.io files to SVG
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Draw.io Desktop and Python dependencies
        run: |
          # Download and install draw.io desktop AppImage
          sudo apt-get update
          sudo apt-get install -y xvfb libasound2t64 python3
          wget -O /tmp/drawio.deb https://github.com/jgraph/drawio-desktop/releases/download/v28.0.6/drawio-amd64-28.0.6.deb
          sudo apt-get install -y /tmp/drawio.deb

      - name: Get changed Draw.io files
        id: changed-files
        run: |
          # Get the list of changed .drawio files
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # First commit in branch, check all .drawio files
            changed_files="$(find . -name "*.drawio" -type f | grep -v "^\./.git/" || true)"
          else
            # Get changed .drawio files from the diff
            changed_files="$(git diff --name-only "${{ github.event.before }}..${{ github.sha }}" | grep "\.drawio$" || true)"
          fi

          if [ -z "$changed_files" ]; then
            echo "No .drawio files changed"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changed .drawio files:"
            echo "$changed_files"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            # Save the list of files for the next step
            echo "$changed_files" > "${{ runner.temp }}/changed_drawio_files.txt"
          fi

      - name: Convert Draw.io files to SVG (Multi-page support)
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          # Read the list of changed files
          while IFS= read -r drawio_file; do
            if [ -f "$drawio_file" ]; then
              # Get the directory and filename without extension
              dir=$(dirname "$drawio_file")
              filename=$(basename "$drawio_file" .drawio)
              svg_file="$dir/$filename.svg"
              
              echo "Processing $drawio_file..."
              
              # Set up environment for draw.io
              # Separate declaration and assignment to avoid masking return values (SC2155)
              XDG_RUNTIME_DIR="/run/user/$(id -u)"
              export XDG_RUNTIME_DIR
              export DBUS_SESSION_BUS_ADDRESS=unix:path="$XDG_RUNTIME_DIR"/bus
              
              # Create temporary directory for individual pages
              temp_dir="${{ runner.temp }}/drawio_pages_$(basename "$drawio_file" .drawio)"
              mkdir -p "$temp_dir"
              
              # Use Python to detect number of pages in the drawio file
              pages=$(python3 scripts/count_drawio_pages.py "$drawio_file")
              
              echo "Detected $pages page(s) in $drawio_file"
              
              if [ "$pages" -eq 1 ]; then
                echo "Single page detected, using direct export..."
                # Single page, direct export
                if xvfb-run --auto-servernum /usr/bin/drawio --no-sandbox --export --format svg --output "$svg_file" "$drawio_file"; then
                  echo "Successfully converted $drawio_file to $svg_file (single page)"
                else
                  echo "Failed to convert $drawio_file"
                  exit 1
                fi
              else
                echo "Multiple pages detected, exporting individual pages..."
                # Multiple pages, export each page individually
                page_files=()
                for ((page_index=1; page_index<=pages; page_index++)); do
                  page_svg="$temp_dir/page_${page_index}.svg"
                  echo "Exporting page $page_index to $page_svg..."
                  
                  if xvfb-run --auto-servernum /usr/bin/drawio --no-sandbox --export --format svg --page-index "$page_index" --output "$page_svg" "$drawio_file"; then
                    if [ -f "$page_svg" ] && [ -s "$page_svg" ]; then
                      echo "Successfully exported page $page_index (size: $(stat -c%s "$page_svg") bytes)"
                      page_files+=("$page_svg")
                    else
                      echo "Warning: Page $page_index export resulted in empty file"
                    fi
                  else
                    echo "Warning: Failed to export page $page_index"
                  fi
                done
                
                echo "Total page files collected: ${#page_files[@]}"
                
                if [ ${#page_files[@]} -eq 0 ]; then
                  echo "No pages were successfully exported, trying fallback single page export..."
                  # Fallback to single page export
                  if xvfb-run --auto-servernum /usr/bin/drawio --no-sandbox --export --format svg --output "$svg_file" "$drawio_file"; then
                    echo "Successfully converted $drawio_file to $svg_file (fallback single page)"
                  else
                    echo "Failed to convert $drawio_file"
                    exit 1
                  fi
                else
                  echo "Combining ${#page_files[@]} pages into single SVG..."
                  echo "Page files to combine:"
                  printf '%s\n' "${page_files[@]}"
                  # Combine pages using Python script
                  if python3 scripts/combine_svgs.py "$svg_file" "${page_files[@]}"; then
                    echo "Successfully combined ${#page_files[@]} pages into $svg_file"
                  else
                    echo "Failed to combine pages for $drawio_file"
                    exit 1
                  fi
                fi
              fi
              
              # Clean up temporary files
              rm -rf "$temp_dir"
              
            else
              echo "File $drawio_file not found, skipping"
            fi
          done < "${{ runner.temp }}/changed_drawio_files.txt"

      - name: Check for changes
        if: ${{ !cancelled() }}
        id: git_diff
        run: |
          git add .
          git diff --cached --quiet && echo 'changes=' >> "$GITHUB_OUTPUT" || echo 'changes=changes' >> "$GITHUB_OUTPUT"

      - name: Get current branch name
        if: ${{ steps.git_diff.outputs.changes == 'changes' && !cancelled() }}
        id: get_branch
        run: |
          echo "branch_name=${GITHUB_REF#refs/heads/}" >> "$GITHUB_OUTPUT"

      - name: Create Pull Request
        if: ${{ steps.git_diff.outputs.changes == 'changes' && !cancelled() }}
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: ${{ steps.get_branch.outputs.branch_name }}
          branch: drawio-to-svg-pr-${{ steps.get_branch.outputs.branch_name }}
          title: "Changes by drawio-to-svg actions"
          labels: fix
