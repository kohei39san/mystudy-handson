---
- name: Delete Custom Resources via kubectl-proxy using curl command
  hosts: localhost
  gather_facts: false
  vars:
    enable_https: "{{ lookup('env', 'ENABLE_HTTPS') | default('false', true) }}"
    https_port: "{{ lookup('env', 'HTTPS_PORT') | default('8443', true) }}"
    http_port: "{{ lookup('env', 'PROXY_PORT') | default('8001', true) }}"
    proxy_protocol: "{{ 'https' if enable_https == 'true' else lookup('env', 'PROXY_PROTOCOL') | default('http', true) }}"
    proxy_port: "{{ https_port if enable_https == 'true' else http_port }}"
    proxy_url: "{{ lookup('env', 'PROXY_URL') | default(proxy_protocol + '://kubectl-proxy:' + proxy_port, true) }}"
    namespace: "{{ lookup('env', 'RESOURCE_NAMESPACE') | default('hoge', true) }}"
    resource_name: "{{ lookup('env', 'RESOURCE_NAME') | default('ansible-website', true) }}"
    crd_group: "{{ lookup('env', 'CRD_GROUP') | default('example.com', true) }}"
    crd_version: "{{ lookup('env', 'CRD_VERSION') | default('v1', true) }}"
    crd_plural: "{{ lookup('env', 'CRD_PLURAL') | default('websites', true) }}"
    validate_certs: "{{ lookup('env', 'VALIDATE_CERTS') | default('no', true) }}"
    curl_insecure: "{{ '-k' if validate_certs == 'no' else '' }}"

  tasks:
    - name: Check if custom resource exists
      ansible.builtin.shell: |
        curl {{ curl_insecure }} -s -o /dev/null -w "%{http_code}" \
          {{ proxy_protocol }}://kubectl-proxy:{{ proxy_port }}/apis/{{ crd_group }}/{{ crd_version }}/namespaces/{{ namespace }}/{{ crd_plural }}/{{ resource_name }}
      register: resource_check
      changed_when: false
      failed_when: false

    - name: Display resource check result
      ansible.builtin.debug:
        msg: "Custom resource '{{ resource_name }}' {{ 'exists' if resource_check.stdout == '200' else 'does not exist' }}"

    - name: Delete custom resource if exists
      ansible.builtin.shell: |
        curl {{ curl_insecure }} -s -X DELETE \
          {{ proxy_protocol }}://kubectl-proxy:{{ proxy_port }}/apis/{{ crd_group }}/{{ crd_version }}/namespaces/{{ namespace }}/{{ crd_plural }}/{{ resource_name }}
      when: resource_check.stdout == "200"
      register: resource_delete
      changed_when: resource_delete.rc == 0

    - name: Display deletion result
      ansible.builtin.debug:
        msg: "Custom resource '{{ resource_name }}' {{ 'deleted successfully' if resource_check.stdout == '200' else 'does not exist' }}"

    - name: Wait for resource deletion to complete
      ansible.builtin.shell: |
        curl {{ curl_insecure }} -s -o /dev/null -w "%{http_code}" \
          {{ proxy_protocol }}://kubectl-proxy:{{ proxy_port }}/apis/{{ crd_group }}/{{ crd_version }}/namespaces/{{ namespace }}/{{ crd_plural }}/{{ resource_name }}
      register: deletion_check
      until: deletion_check.stdout == "404"
      retries: 10
      delay: 2
      changed_when: false
      failed_when: false
      when: resource_check.stdout == "200"

    - name: Confirm deletion
      ansible.builtin.debug:
        msg: "Custom resource '{{ resource_name }}' has been completely removed from the cluster"
      when: resource_check.stdout == "200"
